---
title: "CRD Group15"
output: html_notebook
---

```{r}
library(daewr)
library(caret)
# library(MASS)
```

```{r}
data_clean <- ys1a[!is.na(ys1a$ys), ]

# Chọn các cột cần thiết
columns_to_keep <- c("ys", "vec", "deltachi", "delta", "deltahmix", "deltasmix")
filtered_data <- data_clean[, columns_to_keep]
```

```{r Pilot Experiment tp determine Delta and sigma}
set.seed(123) # Đảm bảo tính tái lập
test_sizes <- c(0.1, 0.2, 0.3)
results <- data.frame(
  test_size = numeric(), 
  replication = integer(), 
  RMSE = numeric(), 
  MAPE = numeric()
)

# Vòng lặp chính: replication = 10
for (i in 1:length(test_sizes)) {
  for (rep in 1:10) {
    # Tạo tập kiểm thử với tỷ lệ test_sizes[i]
    test_index <- sample(1:nrow(filtered_data), size = floor(test_sizes[i] * nrow(filtered_data)))
    train_data <- filtered_data[-test_index, ]
    test_data <- filtered_data[test_index, ]
    
    # Huấn luyện mô hình với tập huấn luyện
    model <- lm(ys ~ vec + deltachi + delta + deltahmix + deltasmix, data = train_data)

    # Dự đoán trên tập kiểm thử
    predictions <- predict(model, newdata = test_data)

    # Tính toán RMSE và MAPE
    RMSE <- sqrt(mean((test_data$ys - predictions)^2))
    MAPE <- mean(abs((test_data$ys - predictions) / test_data$ys)) * 100
    
    # Ghi kết quả vào data.frame
    results <- rbind(results, data.frame(
      test_size = test_sizes[i],
      replication = rep,
      RMSE = RMSE,
      MAPE = MAPE
    ))
  }
}

results
```

```{r Calculate sigma (standard deviation) and Delta of RMSE}
rmse_sigma <- sd(results$RMSE)

# Calculate delta (mean difference of RMSE across test sizes)
group_means <- aggregate(RMSE ~ test_size, data = results, mean)
delta_matrix <- outer(group_means$RMSE, group_means$RMSE, "-")
delta_observed <- abs(delta_matrix[lower.tri(delta_matrix)])
rmse_delta <- mean(delta_observed)

# Output results
cat("Sigma (Standard deviation of RMSE):", rmse_sigma, "\n")
cat("Delta (Mean observed difference in RMSE):", rmse_delta, "\n")
```

```{r Calculate sigma (standard deviation) and Delta of MAPE}
mape_sigma <- sd(results$MAPE)

# Calculate delta (mean difference of MAPE across test sizes)
group_means_mape <- aggregate(MAPE ~ test_size, data = results, mean)
delta_matrix_mape <- outer(group_means_mape$MAPE, group_means_mape$MAPE, "-")
delta_observed_mape <- abs(delta_matrix_mape[lower.tri(delta_matrix_mape)])
mape_delta <- mean(delta_observed_mape)

# Output results for MAPE
cat("Sigma (Standard deviation of MAPE):", mape_sigma, "\n")
cat("Delta (Mean observed difference in MAPE):", mape_delta, "\n")
```

```{r calculate n_rep_min for a given metric}
calculate_n_rep_min <- function(delta, sigma) {
  # Perform power calculations for varying replications
  f_power1_df <- as.data.frame(Fpower1(
    alpha = 0.05, nlev = 3, nreps = 2:1000, Delta = delta, sigma = sigma
  ))
  
  # Filter rows where power exceeds 0.8
  selected_rows <- f_power1_df[f_power1_df$power > 0.8, ]
  
  # Extract minimum nreps achieving power > 0.8
  if (nrow(selected_rows) > 0) {
    n_rep_min <- selected_rows[1, "nreps"]
  } else {
    n_rep_min <- NA  # No nreps achieve power > 0.8
  }
  
  return(n_rep_min)
}

# Calculate n_rep_min for RMSE and MAPE
n_rep_min_rmse <- calculate_n_rep_min(rmse_delta, rmse_sigma)
n_rep_min_mape <- calculate_n_rep_min(mape_delta, mape_sigma)

# Output results
cat("Minimum replications for RMSE:", n_rep_min_rmse, "\n")
cat("Minimum replications for MAPE:", n_rep_min_mape, "\n")
```

```{r Function to perform experiment with replication for RMSE and MAPE}
results <- data.frame(
  test_size = numeric(), 
  replication_type = character(),
  replication = integer(), 
  RMSE = numeric(), 
  MAPE = numeric()
)

# Main loop
for (i in 1:length(test_sizes)) {
  # Separate replication counts for RMSE and MAPE
  for (rep_rmse in 1:n_rep_min_rmse) {
    # Create test and train data for RMSE
    test_index <- sample(1:nrow(filtered_data), size = floor(test_sizes[i] * nrow(filtered_data)))
    train_data <- filtered_data[-test_index, ]
    test_data <- filtered_data[test_index, ]
    
    # Train model
    model <- lm(ys ~ vec + deltachi + delta + deltahmix + deltasmix, data = train_data)
    
    # Predict and calculate RMSE
    predictions <- predict(model, newdata = test_data)
    RMSE <- sqrt(mean((test_data$ys - predictions)^2))
    
    # Append RMSE results
    results <- rbind(results, data.frame(
      test_size = test_sizes[i],
      replication_type = "RMSE",
      replication = rep_rmse,
      RMSE = RMSE,
      MAPE = NA
    ))
  }
  
  for (rep_mape in 1:n_rep_min_mape) {
    # Create test and train data for MAPE
    test_index <- sample(1:nrow(filtered_data), size = floor(test_sizes[i] * nrow(filtered_data)))
    train_data <- filtered_data[-test_index, ]
    test_data <- filtered_data[test_index, ]
    
    # Train model
    model <- lm(ys ~ vec + deltachi + delta + deltahmix + deltasmix, data = train_data)
    
    # Predict and calculate MAPE
    predictions <- predict(model, newdata = test_data)
    MAPE <- mean(abs((test_data$ys - predictions) / test_data$ys)) * 100
    
    # Append MAPE results
    results <- rbind(results, data.frame(
      test_size = test_sizes[i],
      replication_type = "MAPE",
      replication = rep_mape,
      RMSE = NA,
      MAPE = MAPE
    ))
  }
}

rmse_results <- results[results$replication_type == "RMSE", ]
mape_results <- results[results$replication_type == "MAPE", ]

# View results
cat("RMSE Results:\n")
print(rmse_results)

cat("\nMAPE Results:\n")
print(mape_results)
```

```{r ANOVA for RMSE}
anova_RMSE <- aov(RMSE ~ as.factor(test_size), data = rmse_results)
summary(anova_RMSE)
```

```{r ANOVA for MAPE}
anova_MAPE <- aov(MAPE ~ as.factor(test_size), data = mape_results)
summary(anova_MAPE)
```

```{r post-hoc for RMSE}
TukeyHSD(anova_RMSE)
```
```{r post-hoc for MAPE}
TukeyHSD(anova_MAPE)
```

```{r}
system("git branch -a")
system("git remote add origin https://github.com/giakhanh22024558/CRD-Group15.git")
```

```{r}
# Add changes to the staging area
system("git add .")

system("git config --global user.email \"hotmashmallow@gmail.com\"")
system("git config --global user.username \"giakhanh22024558\"")

# Commit with a message (ensure the message is properly quoted)
system("git commit -m \"refactor code\"")
```

```{r}
system("git push origin master:another_way")
```
